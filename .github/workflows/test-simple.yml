name: Run Tests (Simple)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          src/**
          tests/**

    - name: Determine which tests to run
      id: test-scope
      run: |
        CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "scope=all" >> $GITHUB_OUTPUT
          echo "Running all tests (no changed files detected)"
        else
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Map changed source files to test directories
          TEST_DIRS=""
          
          if echo "$CHANGED_FILES" | grep -q "src/data/"; then
            TEST_DIRS="${TEST_DIRS} tests/src/data"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/backtest/"; then
            TEST_DIRS="${TEST_DIRS} tests/src/backtest"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/strategy/"; then
            TEST_DIRS="${TEST_DIRS} tests/src/strategy"
          fi
          
          # If test files changed or no specific scope, run all
          if echo "$CHANGED_FILES" | grep -q "tests/" || [ -z "$TEST_DIRS" ]; then
            echo "scope=all" >> $GITHUB_OUTPUT
          else
            echo "scope=$TEST_DIRS" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Run tests
      run: |
        SCOPE="${{ steps.test-scope.outputs.scope }}"
        
        if [ "$SCOPE" = "all" ]; then
          echo "Running all tests..."
          python -m pytest tests/ -v --tb=short || true
          python -m unittest discover -s tests -p "test_*.py" -v || true
        else
          echo "Running tests for changed modules: $SCOPE"
          for test_dir in $SCOPE; do
            if [ -d "$test_dir" ]; then
              echo "Testing $test_dir..."
              python -m pytest "$test_dir" -v --tb=short || true
              python -m unittest discover -s "$test_dir" -p "test_*.py" -v || true
            fi
          done
        fi

